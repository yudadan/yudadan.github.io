---
layout: post
category : lessons
tagline: ""
tags : [php]
---
{% include JB/setup %}

（1）不管是 windows 还是 linux 操作系统，对于文件内容，假如不是修改操作，只是存储的读，不管是什么编码，对于 PHP 来说都无所谓，当作二进制流处理即可。

（2）而对于文件名，涉及到多个环境，比如操作系统、PHP 文件编码、为了让文件名在终端正常显示，必须小心处理，比如在 windows 上，假如要让用户看到的文件名是正常的，则必须将文件名转换为 GBK（假如不转换，则文件编码是 UTF-8，用户就会看到乱码）。

（3）对于下载文件，Chrome 浏览器比较智能，只要 PHP 一切都用 UTF-8 处理和输出，在下载的时候，Chrome 会自动将文件名转换为中文环境的名称。对于程序来说，需要断用户系统，浏览器等，然后给出用户可以识别的字符集的文件名。

```
$ua   = isset($_SERVER['HTTP_USER_AGENT']) ;
if (stripos($ua, 'msie') !== false) {
    $name = rawurlencode($name);
    header('Content-Disposition: attachment; filename="'.$name.'"');
} else if (stripos($ua, 'edge') !== false) {
    $name = rawurlencode($name);
    header('Content-Disposition: attachment; filename="'.$name.'"');
} elseif (stripos($ua, 'firefox') !== false) {
    $name = rawurlencode($name);
    header('Content-Disposition: attachment; filename*="UTF-8\'\''.$name.'"');
} elseif (stripos($ua, 'chrome') !== false) {
    $name = '=?UTF-8?B?'.base64_encode($name).'?=';
    header('Content-Disposition: attachment; filename="'.$name.'"');
} elseif (stripos($ua, 'safari') !== false || stripos($ua, 'symbianos') !== false || stripos($ua, 'opera') !== false) {
    header('Content-Disposition: attachment; filename="'.$name.'"');
} elseif (stripos($ua, 'windows') !== false) {
    header('Content-Disposition: attachment; filename="'.mb_convert_encoding($name,
'GBK', 'UTF-8').'"');
} else {
    header('Content-Disposition: attachment; filename="'.$name.'"');
}
```

（4）对于文件上传，服务器检测字符集，然后统一转码成 UTF-8 处理。注意不要打开 mbstring.encoding_translation 指令进行自动转换。

（5）UTF-8 有多种表现形式，数据库记得使用 utf8mb4 编码，否则 emoji 会出问题。

（6）gb2312（cp936）->gbk->gb18030

（7）在 SecureCRT 上使用 rz 命令上传一个中文文件到 Linux 服务器上，文件名自动转换为 UTF-8 编码，这个行为是由 SecureCRT 透明处理的。

（8）PHP 不支持处理 unicode，需要自己处理，假如从外部输入读取字符串，并不知道编码来源或者是 (\u 这样的 unicode 字符集)，则需要自己处理。假如语言本身支持 unicode，则处理的时候非常简单，见下面的[例子](http://stackoverflow.com/questions/2934563/how-to-decode-unicode-escape-sequences-like-u00ed-to-proper-utf-8-encoded-cha)。

```
$str = "\u517c\u804c\u5728";
$str = preg_replace_callback('/\\\\u([0-9a-fA-F]{4})/', function ($match) {
    return mb_convert_encoding(pack('H*', $match[1]), 'UTF-8', 'UTF-16BE');
}, $str);
echo $str ;
```

（9）utf8_decode 函数

将用 UTF-8 方式编码的 ISO-8859-1 字符串转换成单字节的 ISO-8859-1 字符串，假如想避免文件名在 windows 系统上出现问题，建议使用支持 ISO-8859-1 字符集的名称。

```
$file = utf8_decode("ml/ÿ.txt") ;
file_put_contents(, "是");
$arr= scandir("./ml");
echo utf8_encode($arr[2]);
```

（10）http://stackoverflow.com/questions/8290537/is-php-str-word-count-multibyte-safe 

 